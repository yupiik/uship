<!DOCTYPE html>
<html lang="en">
<body>

<head>
    <title>HTTP Client</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A light microservice stack.">
    <meta name="author" content="Yupiik Minisite Generator">
    <meta name="generator" content="Yupiik Minisite Generator">
    
    <link rel="shortcut icon" href="//www.yupiik.com/img/favicon.png">

    <link href="//fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,700,700i|Montserrat:300,400,500,700" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin="anonymous" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/asciidoctor.js/1.5.5-5/css/asciidoctor.min.css" integrity="sha512-kI7tn5cuEg16kMeXnYmg8rEJPxbxzEM7Gsr191iQdLDevFBLXPCSU9aZWSVuP61tMZWU3nBAR1cJ7SmXnOGLZw==" crossorigin="anonymous" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.3/css/bootstrap.min.css" integrity="sha512-oc9+XSs1H243/FRN9Rw62Fn8EtxjEYWHXRvjS43YtueEewbS6ObfXcJNyohjHqVKFPoXXUxwc+q1K7Dee6vv9g==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/styles/vs2015.min.css" integrity="sha512-w8aclkBlN3Ha08SMwFKXFJqhSUx2qlvTBFLLelF8sm4xQnlg64qmGB/A6pBIKy0W8Bo51yDMDtQiPLNRq1WMcQ==" crossorigin="anonymous" />
    <link id="theme-style" rel="stylesheet" href="//www.yupiik.io/uship/css/theme.css?v=1.0.9-SNAPSHOT">
    
</head>
    <header class="header fixed-top">
        <div class="branding docs-branding">
            <div class="container-fluid position-relative py-2">
                <div class="docs-logo-wrapper">
	                <div class="site-logo"><a title="Home" class="navbar-brand" href="//www.yupiik.io/uship/index.html">
	                <img class="logo-icon mr-2" src="//www.yupiik.com/img/favicon.png" alt="logo">
	                <span class="logo-text">Yupiik ÂµShip <span class="text-alt">Docs</span></span></a></div>
                </div>
	            <div class="docs-top-utilities d-flex justify-content-end align-items-center">
					
					<li class="list-inline-item"><a title="Search" id="search-button" href="#" data-toggle="modal" data-target="#searchModal"><i data-toggle="tooltip" data-placement="top" title="Search" class="fas fa-search"></i></a></li>

					<ul class="social-list list-inline mx-md-3 mx-lg-5 mb-0 d-none d-lg-flex">
						
						<li class="list-inline-item"><a href="https://www.github.com/yupiik/"><i class="fab fa-github fa-fw"></i></a></li><li class="list-inline-item"><a href="https://www.linkedin.com/company/yupiik/"><i class="fab fa-linkedin fa-fw"></i></a></li>
		            </ul>
	            </div>
            </div>
        </div>
    </header>
	<div class="page">
        <div class="page-navigation-left">
            <h3>Menu</h3>
            <ul>
                <li>
                    <a title="Getting Started" href="//www.yupiik.io/uship/getting-started.html">
                        <i class="fas fa-play"></i>Getting Started
                    </a>
                </li>                <li>
                    <a title="Uship Usage" href="//www.yupiik.io/uship/development-stack.html">
                        <i class="fas fa-code"></i>Usage
                    </a>
                </li>                <li>
                    <a title="Uship Testing" href="//www.yupiik.io/uship/testing.html">
                        <i class="fas fa-vial"></i>Testing
                    </a>
                </li>                <li>
                    <a title="Uship Packaging" href="//www.yupiik.io/uship/packaging.html">
                        <i class="fas fa-file-archive"></i>Packaging
                    </a>
                </li>
            </ul>
        </div>

        <div id="http-client-html-container" class="container page-content http-client-html">
                        <div class="page-header">
                <h1>HTTP Client</h1>
            </div>
            <div class="page-content-body">
                <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>UShip HTTP Client is based on <code>java.net.http.HttpClient</code>.
It is configured with <code>ExtendedHttpClientConfiguration</code> which enables to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>optionally provide a configured <code>HttpClient</code> instance - otherwise the default JVM one is used,</p>
</li>
<li>
<p>optionally provide a set of `RequestListener`s which listen for requests.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_request_listeners">Request Listeners</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Request listener is a callback triggered before and after each request.
It enables to store data before the requests in the caller context and execute some callback once the request is finished.
To pass data between both steps (since the request can be asynchronous or not) it uses a <code>State</code> which can hold any data the listener needs.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
if you write custom listeners (to add OpenTracing capabilities for example), you can make them implement <code>AutoCloseable</code> and when closing the HTTP client the method will be called automatically.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_default_listeners">Default Listeners</h3>
<div class="sect3">
<h4 id="_defaulttimeout"><code>DefaultTimeout</code></h4>
<div class="paragraph">
<p>This listener is pretty straight forward, if the request does not have a timeout, it sets it to the default one configured in the listener.
It enables to enforce a global timeout to all requests.</p>
</div>
</div>
<div class="sect3">
<h4 id="_setuseragent"><code>SetUserAgent</code></h4>
<div class="paragraph">
<p>This listener enforce a custom user-agent value.
It defaults to chrome one.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exchangelogger"><code>ExchangeLogger</code></h4>
<div class="paragraph">
<p>This listener enables to force all exchanges to be logged.</p>
</div>
</div>
<div class="sect3">
<h4 id="_hardumperlistener"><code>HARDumperListener</code></h4>
<div class="paragraph">
<p>This listener enables to capture a <code>HAR</code> dump of all exchanges which went through the client.
It can be very useful to generate some test data you replay with a HAR server in a test or a demo environment.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sample_usage">Sample usage</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">final var conf = new ExtendedHttpClientConfiguration();

// (optional) force a custom SSL context
conf.setDelegate(
    HttpClient.newBuilder()
        .sslContext(getSSLContext())
        .build());

// (optional) force custom listeners
conf.setListeners(List.of(
        new AutoTimeoutSetter(Duration.ofSeconds(3600)),
        new AutoUserAgentSetter(),
        new ExchangeLogger(
            Logger.getLogger(getClass().getName()),
            Clock.systemUTC(),
            false)));</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_open_tracing">(Open) Tracing</h3>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
this is not in the same module, you must add <code>tracing</code> module to get this feature.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>tracing</code> module provides a Tomcat valve you can set up on your web container to add tracing capabilities to your Tomcat:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">final var listener = new TracingListener(
    new ClientTracingConfiguration(), <b class="conum">(1)</b>
    accumulator, <b class="conum">(2)</b>
    new IdGenerator(IdGenerator.Type.HEX), <b class="conum">(3)</b>
    new ServletContextAttributeEvaluator(servletRequest), <b class="conum">(4)</b>
    systemUTC()); <b class="conum">(5)</b>

<b class="conum">(6)</b>
final var configuration = new ExtendedHttpClientConfiguration()
    .setRequestListeners(List.of(listener));
final var client = new ExtendedHttpClient(configuration);</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The configuration enables to customize the span tags and headers to enrich the request with,</p>
</li>
<li>
<p>The accumulator is what will send/log/&#8230;&#8203; the spans once aggregated, ensure to configure it as needed,</p>
</li>
<li>
<p>The <code>IdGenerator</code> provides the span/trace identifiers, it must be compatible with your collector (<code>hex</code> for zipkin for example),</p>
</li>
<li>
<p>Actually a <code>Supplier&lt;Span&gt;</code>, the span evaluator enables to get parent span, here from the <code>request</code> in a <code>webserver-tomcat</code> using <code>Tracingvalve</code> but any evaluation will work,</p>
</li>
<li>
<p>The clock enables to timestamp the span and compute its duration,</p>
</li>
<li>
<p>Finally, add the listener to your http client configuration and create your client.</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
the accumulator should generally be closed if you reuse <code>AccumulatingSpanCollector</code>. You can combine it with <code>ZipkinFlusher</code> to flush to a zipkin collector v2.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_kubernetes_client">Kubernetes client</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>kubernetes-client</code> modules providers a HTTP Client already configured for Kubernetes in cluster connection (from a POD).
This will typically be used from an operator or cloud native application to call Kubernetes API using a plain and very light HTTP Client from the JVM.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
indeed you can combine it with the enhanced HTTP Client configuring it in the <code>KubernetesClientConfiguration</code>.
However, it is recommended to do it using <code>setClientWrapper</code> on the configuration and pass the automatically created client to <code>ExtendedHttpClientConfiguration.setDelegate</code>
to avoid to have to handle the <code>SSLContext</code> yourself.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">final var conf = new KubernetesClientConfiguration()
    .setClientWrapper(client -&gt; new ExtendedHttpClient(new ExtendedHttpClientConfiguration()
        .setDelegate(client)));
final var k8s = new KubernetesClient(conf);

// now call any API you need:
final var response = k8s.send(
        HttpRequest.newBuilder()
                .GET()
                .uri(URI.create(
                    "https://kubernetes.api/api/v1/namespaces/" + k8s.namespace().orElse("default") + "/configmaps?" +
                            "includeUninitialized=false&amp;" +
                            "limit=1000&amp;" +
                            "timeoutSeconds=600")
                .header("Accept", "application/json")
                .build(),
        HttpResponse.BodyHandlers.ofString(StandardCharsets.UTF_8));
// handle the response</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
as you can see, there is no need to pass the token to the request, it is done under the hood by the <code>KubernetesClient</code>.
The other important note is that <code><a href="https://kubernetes.api" class="bare">https://kubernetes.api</a></code> is automatically replaced by the <code>conf.getMaster()</code> value.
This enables your code to stay more straight forward in general but if you pass them, the client will handle it properly too.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_json_rpc_client">JSON-RPC client</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As a JSON-RPC server companion UShip also provides a JSON-RPC client.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
  &lt;groupId&gt;io.yupiik.uship&lt;/groupId&gt;
  &lt;artifactId&gt;jsonrpc-client&lt;/artifactId&gt;
  &lt;version&gt;${uship.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The minimum configuration is to provide the JSON-RPC endpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">final var client = new JsonRpcClient(new JsonRpcClientConfiguration("http://app.service.com/jsonrpc"));</code></pre>
</div>
</div>
<div class="paragraph">
<p>But more is customizable in <code>JsonRpcClientConfiguration</code> and a common initialization would look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Produces
@ApplicationScoped
public ExtendedHttpClient jsonRpcHttpClient() {
    return ...; // create it as usual
}

public void releaseHttpClient(@Disposes final ExtendedHttpClient client) {
    client.close();
}

@Produces
@ApplicationScoped
public JsonRpcClient jsonRpcClient(
            // external config
            @ConfigProperty("jsonrpc.base") final String base,
            @ConfigProperty("jsonrpc.authorizationheader") final String auth,
            // from uship json in general
            final JsonBuilderFactory jbf, final Jsonb jsonb,
            // created in the app (other producer)
            final ExtendedHttpClient client) {
    return new JsonRpcClient(new JsonRpcClientConfiguration(base + "/jsonrpc"))
        // all these setters are optional but enables to use controlled instances (vs implicit) and optimize/customize the behavior/mem/security
        .setJsonBuilderFactory(jbf)
        .setJsonb(jsonb)
        .setHttpClient(client) // enables to customize the async thread pool for example (highly encourage for executeAsync usage)
        .setRequestCustomizer(req -&gt; req.header("authorization", auth));
}

@Produces
@ApplicationScoped // to be able to @Inject JsonRpcClient.Sync sync; directory - or similarly for async
public JsonRpcClient.Sync jsonRpcClient(final JsonRpcClient root) {
    return root.sync();
}

public void releaseJsonRpcClient(@Disposes final JsonRpcClient client) {
    client.close();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can simply use it in your application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@ApplicationScoped
public class MyService {
    @Inject
    private JsonRpcClient client;

    public CompletionStage&lt;Customer&gt; findCustomer(final String id) {
        return client.async().execute("app-customer-find-by-id", Map.of("id", id))
            // todo: better error handling if needed
            .thenApply(r -&gt; r.asSingle().as(Customer.class));
    }
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_bulk_handling">Bulk handling</h3>
<div class="paragraph">
<p>Bulk is handled relying on the JSON-RPC protocol accessible from the client - or directly if you prefer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">final var protocol = client.protocol();
final var response = client.sync().execute(protocol.jsonBuilderFactory().createArrayBuilder()
        .add(protocol.toJsonRpcRequest("m1", Map.of("foo", "bar")))
        .add(protocol.toJsonRpcRequest("m2", new M2Params()))
        .add(protocol.toJsonRpcRequest("m3", null))
        .build());</code></pre>
</div>
</div>
</div>
</div>
</div>
                
            </div>
        </div>
    <div class="page-navigation-right">
        <h3>Navigation</h3>
        <nav class="generated-nav-menu"></nav>
    </div>
    </div>
    <hr />
    <footer class="footer pb-5">
	    <div class="footer-bottom text-center">
		    <ul class="social-list list-unstyled">
                <li class="list-inline-item"><a href="https://www.github.com/yupiik/"><i class="fab fa-github fa-fw"></i></a></li><li class="list-inline-item"><a href="https://www.linkedin.com/company/yupiik/"><i class="fab fa-linkedin fa-fw"></i></a></li>
	        </ul>
            <small class="copyright">Yupiik &copy;</small> | <a href="https://www.yupiik.com/terms-of-service/">Terms of service</a> | <a href="https://www.yupiik.com/privacy-policy/">Privacy policy</a>
	    </div>
    </footer>

    <div class="modal fade" id="searchModal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="searchModalLabel">Search</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form onsubmit="return false;" class="form-inline">
          <div class="form-group">
            <label for="searchInput"><b>Search: </b></label>
            <input class="form-control" id="searchInput" placeholder="Enter search text and hit enter...">
          </div>
        </form>
        <div class="search-hits"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" ></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.3/js/bootstrap.min.js" integrity="sha512-8qmis31OQi6hIRgvkht0s6mCOittjMa9GMqtK9hes5iEQBQE/Ca6yGE5FsW36vyipGoWQswBj/QBm2JR086Rkw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/highlight.min.js" integrity="sha512-d00ajEME7cZhepRqSIVsQVGDJBdZlfHyQLNC6tZXYKTG7iwcF8nhlFuppanz8hYgXr8VvlfKh4gLC25ud3c90A==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/languages/bash.min.js" integrity="sha512-Hg0ufGEvn0AuzKMU0psJ1iH238iUN6THh7EI0CfA0n1sd3yu6PYet4SaDMpgzN9L1yQHxfB3yc5ezw3PwolIfA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/languages/bash.min.js" integrity="sha512-Hg0ufGEvn0AuzKMU0psJ1iH238iUN6THh7EI0CfA0n1sd3yu6PYet4SaDMpgzN9L1yQHxfB3yc5ezw3PwolIfA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/languages/json.min.js" integrity="sha512-37sW1XqaJmseHAGNg4N4Y01u6g2do6LZL8tsziiL5CMXGy04Th65OXROw2jeDeXLo5+4Fsx7pmhEJJw77htBFg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/languages/dockerfile.min.js" integrity="sha512-eRNl3ty7GOJPBN53nxLgtSSj2rkYj5/W0Vg0MFQBw8xAoILeT6byOogENHHCRRvHil4pKQ/HbgeJ5DOwQK3SJA==" crossorigin="anonymous"></script>
    <script>if (!(window.minisite || {}).skipHighlightJs) { hljs.highlightAll(); }</script>
    <script src="//www.yupiik.io/uship/js/minisite.js?v=1.0.9-SNAPSHOT"></script>
    <script>$('.page-content-body').generatedNavMenu();</script>
    <script>
            document.querySelector('div.site-logo > a').href =
            document.location.pathname.indexOf('/uship') == 0 ? '/uship/index.html' : '/index.html';
            </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.3/fuse.min.js" integrity="sha512-neoBxVNv0UMXjoilAYGxfWrSsW6iAVclx7vQKdPJ9Peet1bM5YQjU0aIB8LtH8iNPa+pAyMZprBBw2ZQ/Q1LjQ==" crossorigin="anonymous"></script>

</body>
</html>
