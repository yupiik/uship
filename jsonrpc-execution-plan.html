<!DOCTYPE html>
<html lang="en">
<body>

<head>
    <title>JSON-RPC execution plan example</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A light microservice stack.">
    <meta name="author" content="Yupiik Minisite Generator">
    <meta name="generator" content="Yupiik Minisite Generator">
    
    <link rel="shortcut icon" href="//www.yupiik.com/img/favicon.png">

    <link href="//fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,700,700i|Montserrat:300,400,500,700" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin="anonymous" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/asciidoctor.js/1.5.5-5/css/asciidoctor.min.css" integrity="sha512-kI7tn5cuEg16kMeXnYmg8rEJPxbxzEM7Gsr191iQdLDevFBLXPCSU9aZWSVuP61tMZWU3nBAR1cJ7SmXnOGLZw==" crossorigin="anonymous" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.3/css/bootstrap.min.css" integrity="sha512-oc9+XSs1H243/FRN9Rw62Fn8EtxjEYWHXRvjS43YtueEewbS6ObfXcJNyohjHqVKFPoXXUxwc+q1K7Dee6vv9g==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/styles/vs2015.min.css" integrity="sha512-w8aclkBlN3Ha08SMwFKXFJqhSUx2qlvTBFLLelF8sm4xQnlg64qmGB/A6pBIKy0W8Bo51yDMDtQiPLNRq1WMcQ==" crossorigin="anonymous" />
    <link id="theme-style" rel="stylesheet" href="//yupiik.github.io/uship/css/theme.css?v=1.0.5-SNAPSHOT">
    
</head>
    <header class="header fixed-top">
        <div class="branding docs-branding">
            <div class="container-fluid position-relative py-2">
                <div class="docs-logo-wrapper">
	                <div class="site-logo"><a title="Home" class="navbar-brand" href="//yupiik.github.io/uship/index.html">
	                <img class="logo-icon mr-2" src="//www.yupiik.com/img/favicon.png" alt="logo">
	                <span class="logo-text">Yupiik ÂµShip <span class="text-alt">Docs</span></span></a></div>
                </div>
	            <div class="docs-top-utilities d-flex justify-content-end align-items-center">
					
					<li class="list-inline-item"><a title="Search" id="search-button" href="#" data-toggle="modal" data-target="#searchModal"><i data-toggle="tooltip" data-placement="top" title="Search" class="fas fa-search"></i></a></li>

					<ul class="social-list list-inline mx-md-3 mx-lg-5 mb-0 d-none d-lg-flex">
						
						<li class="list-inline-item"><a href="https://www.github.com/yupiik/"><i class="fab fa-github fa-fw"></i></a></li><li class="list-inline-item"><a href="https://www.linkedin.com/company/yupiik/"><i class="fab fa-linkedin fa-fw"></i></a></li>
		            </ul>
	            </div>
            </div>
        </div>
    </header>
	<div class="page">
        <div class="page-navigation-left">
            <h3>Menu</h3>
            <ul>
                <li>
                    <a title="Getting Started" href="//yupiik.github.io/uship/getting-started.html">
                        <i class="fas fa-play"></i>Getting Started
                    </a>
                </li>                <li>
                    <a title="Uship Usage" href="//yupiik.github.io/uship/development-stack.html">
                        <i class="fas fa-code"></i>Usage
                    </a>
                </li>                <li>
                    <a title="Uship Testing" href="//yupiik.github.io/uship/testing.html">
                        <i class="fas fa-vial"></i>Testing
                    </a>
                </li>                <li>
                    <a title="Uship Packaging" href="//yupiik.github.io/uship/packaging.html">
                        <i class="fas fa-file-archive"></i>Packaging
                    </a>
                </li>
            </ul>
        </div>

        <div id="jsonrpc-execution-plan-html-container" class="container page-content jsonrpc-execution-plan-html">
                        <div class="page-header">
                <h1>JSON-RPC execution plan example</h1>
            </div>
            <div class="page-content-body">
                <div class="paragraph">
<p>On this page we want to implement a first optimization on our JSON-RPC server.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
this page will not go through the complete details of such optimization and only consider the pure case where all requests match but a real implement could group requests to still optimize the execution when sub requests are groupable (a plan should group requests and use the optimize case when possible and not only optimize all or nothing).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The use case is the following one:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You have a JSON-RPC method <code>findById</code> which takes two parameters <code>id</code> and <code>logo</code> (a boolean to request to include the logo url or not),</p>
</li>
<li>
<p>You have a java service method called <code>findByIds</code> which can load multiple entities at once (<code>WHERE id in (&#8230;&#8203;)</code>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The idea is to replace a bulk request of <code>findById</code> by an optimized execution using <code>findByIds</code> making the server execution optimized even if the client request is not optimal.</p>
</div>
<div class="paragraph">
<p>Here is a sample implementation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Specializes
@ApplicationScoped
public class EnrichedJsonRpcHandler extends JsonRpcHandler {
    @Inject
    @JsonRpc
    private SearchService searcher;

    @Inject
    private Jsonb jsonb;

    @Inject
    private JsonBuilderFactory jsonBuilderFactory;

    @Override
    public CompletionStage&lt;?&gt; execute(final JsonStructure request,
                                      final HttpServletRequest httpRequest,
                                      final HttpServletResponse httpResponse) {
        if (request.getValueType() != JsonValue.ValueType.ARRAY) { // <b class="conum">(1)</b>
            return super.execute(request, httpRequest, httpResponse);
        }

        final var req = request.asJsonArray();
        if (req.isEmpty()) { // <b class="conum">(2)</b>
            return super.execute(request, httpRequest, httpResponse);
        }

        final var first = req.get(0);
        if (first.getValueType() != JsonValue.ValueType.OBJECT) { // <b class="conum">(3)</b>
            return super.execute(request, httpRequest, httpResponse);
        }

        final var obj = first.asJsonObject();
        final var name = obj.get("method");
        if (name == null || name.getValueType() != JsonValue.ValueType.STRING) { // <b class="conum">(4)</b>
            return super.execute(request, httpRequest, httpResponse);
        }

        // <b class="conum">(5)</b>
        return executeWithOptimizations(request, httpRequest, httpResponse, req, obj, JsonString.class.cast(name).getString());
    }

    private CompletionStage&lt;?&gt; executeWithOptimizations( // <b class="conum">(6)</b>
            final JsonStructure request, final HttpServletRequest httpRequest, final HttpServletResponse httpResponse,
            final JsonArray req, final JsonObject firstItem, final String method) {
        switch (method) {
            case "findById":
                return findByIds(request, httpRequest, httpResponse, req, firstItem);
            default:
                return super.execute(request, httpRequest, httpResponse);
        }
    }

    private CompletionStage&lt;?&gt; findByIds(final JsonStructure request,
                                         final HttpServletRequest httpRequest,
                                         final HttpServletResponse httpResponse,
                                         final JsonArray req,
                                         final JsonObject firstItem) {
        final var requests = req.stream()
                .filter(it -&gt; it.getValueType() == JsonValue.ValueType.OBJECT)
                .map(JsonValue::asJsonObject)
                .toList();
        if (requests.size() != req.size()) { // <b class="conum">(7)</b>
            return super.execute(request, httpRequest, httpResponse);
        }

        final var params = firstItem.get("params");
        if (params == null || params.getValueType() != JsonValue.ValueType.OBJECT) { // <b class="conum">(8)</b>
            return super.execute(request, httpRequest, httpResponse);
        }

        final var icons = params.asJsonObject().get("logo");
        // <b class="conum">(9)</b>
        if (icons.getValueType() != JsonValue.ValueType.TRUE &amp;&amp;
                icons.getValueType() != JsonValue.ValueType.FALSE) {
            return super.execute(request, httpRequest, httpResponse);
        }
        // <b class="conum">(10)</b>
        if (requests.stream()
                        .skip(1)
                        .map(it -&gt; it.get("params"))
                        .anyMatch(p -&gt; p == null ||
                                p.getValueType() != JsonValue.ValueType.OBJECT ||
                                !Objects.equals(icons, p.asJsonObject().get("logo")))) {
            return super.execute(request, httpRequest, httpResponse);
        }

        // <b class="conum">(11)</b>
        final var ids = requests.stream()
                .map(it -&gt; it.get("params").asJsonObject())
                .map(it -&gt; it.get("id"))
                .filter(Objects::nonNull)
                .filter(it -&gt; it.getValueType() == JsonValue.ValueType.STRING)
                .map(JsonString.class::cast)
                .map(JsonString::getString)
                .toList();
        if (ids.size() != requests.size()) { // wrongly formatted request, let it go
            return super.execute(request, httpRequest, httpResponse);
        }

        // <b class="conum">(12)</b>
        if (ids.size() &gt; 50) { // likely not supported properly - later group by chunks of 50, for now it is ok
            return super.execute(request, httpRequest, httpResponse);
        }

        // <b class="conum">(13)</b>
        httpResponse.setHeader("JsonRpc-Rewritten", "true");

        // <b class="conum">(14)</b>
        final var byId = searcher.findByMultipleCIS(ids, JsonValue.TRUE.equals(icons));
        final var reqIterator = requests.iterator();
        final var responses = ids.stream() // <b class="conum">(15)</b>
                .map(it -&gt; {
                    final var response = new Response();
                    response.setJsonrpc("2.0");

                    final var id = reqIterator.next().get("id");
                    if (id != null) {
                        response.setId(id);
                    }

                    final var value = byId.get(it);
                    if (value == null) {
                        response.setError(new Response.ErrorResponse(
                                404, "Entity '" + id + "' not found",
                                jsonBuilderFactory.createObjectBuilder()
                                        .add("id", it)
                                        .build()));
                    } else {
                        // or use johnzon more optimized round trip using a JsonValueReader or alike
                        response.setResult(jsonb.fromJson(jsonb.toJson(value), JsonObject.class));
                    }
                    return response;
                })
                .toArray(Response[]::new);
        return completedFuture(responses); // <b class="conum">(16)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>If not a bulk request we don&#8217;t optimize it, so we early quit,</p>
</li>
<li>
<p>If not an empty bulk request we can&#8217;t optimize it, so we early quit,</p>
</li>
<li>
<p>If the first bulk request is not an object we can&#8217;t evaluate it so use the default runtime to fail,</p>
</li>
<li>
<p>If the first bulk item does not have a method attribute we can&#8217;t evaluate it so use the default runtime to fail,</p>
</li>
<li>
<p>If previous conditions are met, try to optimize the execution,</p>
</li>
<li>
<p>This method enables us to route the optimizations specifically for a method (simpler to maintain),</p>
</li>
<li>
<p>If any request of the bulk is not a request then we can&#8217;t evaluate it so use the default runtime to fail,</p>
</li>
<li>
<p>If any request of the bulk is missing some parameter (keep in mind <code>id</code> and <code>logo</code> are required there) then we use the default runtime to fail,</p>
</li>
<li>
<p>If <code>logo</code> value is invalid use the default runtime to fail,</p>
</li>
<li>
<p>If multiple <code>logo</code> values, keep the default runtime execution (one by one instead of at once) - note that here we could group by <code>logo</code> value to do 2 optimizations or a more advanced query to optimize the runtime (out of scope of this post),</p>
</li>
<li>
<p>Extract all identifiers for the bulk request,</p>
</li>
<li>
<p>If we have too many requests then fail - note that we could group there too but bulk request max size is <code>50</code> so we just aligned the value there (and luckily it is also aligned on the most common SQL limitations),</p>
</li>
<li>
<p>Totally optional but we enrich the response to notify the caller we rewrote the execution (can be useful for debug purposes),</p>
</li>
<li>
<p>We do the optimized execution,</p>
</li>
<li>
<p>we map the result of the optimized execution to atomic <code>Response</code> (for each incoming request of the bulk request),</p>
</li>
<li>
<p>Since our optimized execution was synchronous we wrap the responses in a <code>CompletionStage</code> - not needed if you already have one.</p>
</li>
</ol>
</div>
                
            </div>
        </div>
    <div class="page-navigation-right">
        <h3>Navigation</h3>
        <nav class="generated-nav-menu"></nav>
    </div>
    </div>
    <hr />
    <footer class="footer pb-5">
	    <div class="footer-bottom text-center">
		    <ul class="social-list list-unstyled">
                <li class="list-inline-item"><a href="https://www.github.com/yupiik/"><i class="fab fa-github fa-fw"></i></a></li><li class="list-inline-item"><a href="https://www.linkedin.com/company/yupiik/"><i class="fab fa-linkedin fa-fw"></i></a></li>
	        </ul>
            <small class="copyright">Yupiik &copy;</small> | <a href="https://www.yupiik.com/terms-of-service/">Terms of service</a> | <a href="https://www.yupiik.com/privacy-policy/">Privacy policy</a>
	    </div>
    </footer>

    <div class="modal fade" id="searchModal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="searchModalLabel">Search</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form onsubmit="return false;" class="form-inline">
          <div class="form-group">
            <label for="searchInput"><b>Search: </b></label>
            <input class="form-control" id="searchInput" placeholder="Enter search text and hit enter...">
          </div>
        </form>
        <div class="search-hits"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" ></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.3/js/bootstrap.min.js" integrity="sha512-8qmis31OQi6hIRgvkht0s6mCOittjMa9GMqtK9hes5iEQBQE/Ca6yGE5FsW36vyipGoWQswBj/QBm2JR086Rkw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/highlight.min.js" integrity="sha512-d00ajEME7cZhepRqSIVsQVGDJBdZlfHyQLNC6tZXYKTG7iwcF8nhlFuppanz8hYgXr8VvlfKh4gLC25ud3c90A==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/languages/bash.min.js" integrity="sha512-Hg0ufGEvn0AuzKMU0psJ1iH238iUN6THh7EI0CfA0n1sd3yu6PYet4SaDMpgzN9L1yQHxfB3yc5ezw3PwolIfA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/languages/bash.min.js" integrity="sha512-Hg0ufGEvn0AuzKMU0psJ1iH238iUN6THh7EI0CfA0n1sd3yu6PYet4SaDMpgzN9L1yQHxfB3yc5ezw3PwolIfA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/languages/json.min.js" integrity="sha512-37sW1XqaJmseHAGNg4N4Y01u6g2do6LZL8tsziiL5CMXGy04Th65OXROw2jeDeXLo5+4Fsx7pmhEJJw77htBFg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/languages/dockerfile.min.js" integrity="sha512-eRNl3ty7GOJPBN53nxLgtSSj2rkYj5/W0Vg0MFQBw8xAoILeT6byOogENHHCRRvHil4pKQ/HbgeJ5DOwQK3SJA==" crossorigin="anonymous"></script>
    <script>if (!(window.minisite || {}).skipHighlightJs) { hljs.highlightAll(); }</script>
    <script src="//yupiik.github.io/uship/js/minisite.js?v=1.0.5-SNAPSHOT"></script>
    <script>$('.page-content-body').generatedNavMenu();</script>
    <script>
            document.querySelector('div.site-logo > a').href =
            document.location.pathname.indexOf('/uship') == 0 ? '/uship/index.html' : '/index.html';
            </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.3/fuse.min.js" integrity="sha512-neoBxVNv0UMXjoilAYGxfWrSsW6iAVclx7vQKdPJ9Peet1bM5YQjU0aIB8LtH8iNPa+pAyMZprBBw2ZQ/Q1LjQ==" crossorigin="anonymous"></script>

</body>
</html>
